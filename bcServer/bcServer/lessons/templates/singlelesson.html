<html><body bgcolor = "#F5F3EE">
<script src="https://code.jquery.com/jquery-1.10.2.js"></script>
<style>
button {
  background-color: #4A96AD;
  color:white
}
table {
    margin-top: 18px;
    border: 1px solid black;
    border-collapse: collapse;
}
td {
  padding: 10px;
  border: 1px solid black;
  border-collapse: collapse;
  vertical-align: top;
}
input[type=submit] {
  background-color: #4A96AD;
  color:white
}
input[type=button] {
  margin-left: 5px;
  background-color: #4A96AD;
  color:white
}
input[type=file] {
  width: 160px
}
</style>
</head>
<body>
<button onClick ="window.location.href='../'">back</button>
<input type="button" value="logout" onclick="logout()"/>
<h1 id="title"></h1>
<p id = "problem"></p>
<form id="downloadInputsForm" method="get">
  <input type="submit" value="Download inputs"/>
</form>
<ul id="hints">
</ul>
<div style = "float: left">
<form id="newHintForm" method="get">
  <input type="submit" value="Get new hint"/>
</form>
<form id="upload" method="post" enctype="multipart/form-data">
  <input type="file" name="submittedFile" id="submittedFile" />
  <input type="button" name="submit" value="Submit" onclick="uploadFile();" />
</form>
<button id="submitToggleButton" onclick="toggleShowSubmits()">Show results</button>
<ul id= "submits" > </ul>
<form id = "ratingForm" method = "post" >
  <div id = "rating">
  </div>
</form>
<form id="commentForm" method="post" style="width:35%">
  <h3> Leave a comment:</h3>
  <textarea name="text" rows="5" cols="70"></textarea> <br>
  <input type="submit" value="Send"/>
</form>
<table rules="rows" border="1" style="width:440px" id = "discussion"></table>
</div>

<div style="float: left ;margin-top:100px">
</div>
<script>


var submitResultsHTML
var id = window.location.pathname.split('/')[2]
$(document).ready(function(){
//  alert('ready')
  document.getElementById("submits").innerHTML = ""
  document.getElementById("downloadInputsForm").action = "../../api/"+id+"/download"
  var getLocation = function(href) {
      var l = document.createElement("a");
      l.href = href;
      return l;
  };
  $.ajax({
       url: "../../api/lesson/"+id+"/",
       type: "GET",
       headers: {'Authorization':'Token '+localStorage.getItem('token')},
       success: function(data) {
         console.log(JSON.stringify(data));
         document.getElementById("title").innerHTML = "Lesson "+data['name']
         document.getElementById("problem").innerHTML = "<b>Problem:</b> <br> <pre>"+data['problem']+"</pre>"
         console.log(data['interactive'])
         if (!data['interactive']) {
           document.getElementById("downloadInputsForm").innerHTML = ""
           document.getElementById("upload").innerHTML = ""
           document.getElementById("newHintForm").innerHTML = ""
         }
        //document.getElementById("loggedInAs").innerHTML = "logged in as "+ data['username']
       },
       error: function(data) {
         if (data.status==401) {
           window.location.replace("../../user/login/")
         }
       }
    });
  $.ajax({
       url: "../../api/discussion/"+id+"",
       type: "GET",
       headers: {'Authorization':'Token '+localStorage.getItem('token')},
       success: function(data) {
         console.log(JSON.stringify(data));
         var discussion = document.getElementById("discussion")
         for (var i = 0; i < data.length; i++){
           discussion.innerHTML += "<tr><th align=\"left\"><h3>"+ data[i].username +"</h3><pre>"+data[i].text+"</pre></th></tr>"
         }
       },
       error: function(data) {
         if (data.status==401) {
           window.location.replace("../../user/login/")
         }
       }
    });
  $.ajax({
       url: "../../user/api/"+id+"/wrapper/",
       type: "GET",
       headers: {'Authorization':'Token '+localStorage.getItem('token')},
       success: function(data) {
         if(data[0]['completed']) {
            document.getElementById("rating").innerHTML = document.getElementById("ratingFormHTML").innerHTML
          }
       },
       error: function(data) {
         if (data.status==401) {
           window.location.replace("../../user/login/")
         }
       }
    });
  $.ajax({
       url: "../../api/hints/"+id,
       type: "GET",
       headers: {'Authorization':'Token '+localStorage.getItem('token')},
       success: function(data) {
         hintTarget = document.getElementById("hints")
         var hintArray = []
         for (var i = 0; i < data.length; i++) {
           hintTarget.innerHTML += "<li>"+data[i].text+"</li>"
         }
       },
       error: function(data) {
         if (data.status==401) {
           window.location.replace("../../user/login/")
         }
       }
    });

    getSubmits(()=>{})

    $("#newHintForm").submit(function (e) {
      e.preventDefault()
      $.ajax({
         url: "../../api/newhint/"+id,
         type: "GET",
         headers: {'Authorization':'Token '+localStorage.getItem('token')},
         success: function(data) {

           console.log(JSON.stringify(data))
           hintTarget = document.getElementById("hints")
           hintTarget.innerHTML = ""
           var hintArray = []
           for(var i = 0; i < data.length; i++) {
             hintTarget.innerHTML += "<li>"+data[i].text+"</li>"
           }
         },
         error: function(data) {
           if (data.status==401) {
             window.location.replace("../../user/login/")
           }
         }
       })
     });
  $("#commentForm").submit(function(e) {
    e.preventDefault()
    $.ajax({
      type: "POST",
      url: "../../api/discussion/"+id+"/",
      headers: {'Authorization':'Token '+localStorage.getItem('token')},
      data : $("#commentForm").serialize(),
      success: function() {
        location.reload()
      }
    })


  })
  var ratingForm = $("#ratingForm")
  ratingForm.submit(function(e) {
    e.preventDefault()
    console.log('serialized '+ratingForm.serialize())
    $.ajax({
      type: "POST",
      url: "../../stats/"+id+"/rating/",
      headers: {'Authorization':'Token '+localStorage.getItem('token')},
      data: ratingForm.serialize(),
      success: function(e) {
          console.log(JSON.stringify(e))
          return false
      },
      error: function(data) {
        if (data.status==401) {
          window.location.replace("../../user/login/")
        }
      }
    })
  })
})

function logout(){
  $.ajax({
    type: "GET",
    url: "../../user/logout",
    headers: {'Authorization':'Token '+localStorage.getItem('token')},
  })
  delete localStorage.removeItem('token')
  window.location.href="../../user/login/"
}

function uploadFile(){
    var id = window.location.pathname.split('/')[2]
    var xmlhttp;
    if (window.XMLHttpRequest)
    {// code for IE7+, Firefox, Chrome, Opera, Safari
        xmlhttp=new XMLHttpRequest();
    }
    else
    {// code for IE6, IE5
        xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
    }
    var formElement = document.getElementById("upload");
    var formData= new FormData(formElement);
    xmlhttp.open("post","../../api/"+id+"/submitfile/",false);
    xmlhttp.setRequestHeader("Authorization", 'Token '+localStorage.getItem('token'))
    xmlhttp.send(formData);
    var counter = 0;
    while (xmlhttp.readyState != 4){
        counter = counter + 1;
    }
    var response =  xmlhttp.responseText;
    document.getElementById("submittedFile").value = ""
    getSubmits(() => {document.getElementById("submits").innerHTML = submitResultsHTML})
}

function toggleShowSubmits() {
  if (document.getElementById("submitToggleButton").innerHTML == "Show results") {
    document.getElementById("submitToggleButton").innerHTML = "Hide results"
    document.getElementById("submits").innerHTML = submitResultsHTML
  } else {
    document.getElementById("submitToggleButton").innerHTML = "Show results"
    document.getElementById("submits").innerHTML = ""
  }
}
function getSubmits(callback) {
  $.ajax({
     url: "../../api/submits/"+id,
     type: "GET",
     headers: {'Authorization':'Token '+localStorage.getItem('token')},
     success: function(data) {
       submitResultsHTML = ""
       submitTarget = document.getElementById("submits")
       for (var i = data.length-1; i >= 0; i--) {
         submitResultsHTML += "<li>"+data[i].result+"</li>"
       }
       console.log(submitResultsHTML)
       callback()
     },
     error: function(data) {
       if (data.status==401) {
         window.location.replace("../../user/login/")
       }
     }
  });
}

</script>

<script id = "ratingFormHTML" language="text">
  <h5>Rate the lesson!</h5>
    <label for="fun">Fun</label>
    <input type="number" name="fun" min="1" max="5" id = "fun"> <br>
    <label for="difficulty">Difficulty</label>
    <input type="number" name="difficulty" min="1" max="5" id = "difficulty"> <br>
    <input type="submit" value="Post rating">
</script>
</body></html>
